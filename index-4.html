<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HydroCalc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --dark-bg: #1e293b;
            --dark-card-bg: #334155;
            --dark-border: #475569;
            --dark-text-primary: #f1f5f9;
            --dark-text-secondary: #94a3b8;
            --dark-input-bg: #475569;
            --dark-icon-color: #FFDE59;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #e2e8f0;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(to bottom, #f87171, #ef4444);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transform: scale(1);
        }
        .btn-primary:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }
        .btn-primary:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.3);
        }
        .btn-secondary {
            background-color: #334155;
            color: white;
            transform: scale(1);
        }
        .btn-secondary:hover {
            background-color: #1e293b;
            transform: scale(1.05);
        }
        .btn-secondary:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(51, 65, 85, 0.3);
        }
        .btn-delete {
            background-color: #fee2e2;
            color: #dc2626;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .btn-delete:hover {
            background-color: #fecaca;
            transform: scale(1.1);
        }
        .btn-delete:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.3);
        }
        .custom-select {
            appearance: none;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2394a3b8'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .custom-select:hover {
            border-color: #2563eb;
        }
        .custom-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
        }
        .establishment-line {
            border-left: 2px solid #e2e8f0;
            padding-left: 1rem;
            margin-left: 1rem;
            transition: border-color 0.3s ease;
        }

        .dark-mode-toggle-container {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 10;
        }
        .dark-mode-btn {
            background-color: #fff;
            width: 60px;
            height: 30px;
            border-radius: 10em;
            padding: 0 4px;
            box-shadow: inset 0 2px 20px rgba(0,0,0, .1),
                        inset 0 2px 2px rgba(0,0,0, .1),
                        inset 0 -1px 1px rgba(0,0,0, .1);
            position: relative;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .dark-mode-btn__indicator {
            background-color: #fff;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            position: absolute;
            box-shadow: 0 2px 15px rgba(0,0,0, .2);
            transition: transform 0.3s ease;
        }
        body.dark .dark-mode-btn__indicator {
            transform: translateX(30px);
        }
        .dark-mode-btn__icon-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .dark-mode-btn__icon {
            color: var(--dark-icon-color);
            font-size: 0.9rem;
            transition: transform 0.3s ease;
        }
        .dark-mode-btn__icon.animated {
            animation: spin 0.5s;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .layout-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: rotate(0deg);
            transition: transform 0.3s ease;
        }
        .layout-fullscreen .card {
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }
        .layout-svg-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }
        .layout-fullscreen .layout-svg-container {
            max-width: 100%;
        }
        @media (max-width: 640px) {
            .layout-fullscreen {
                transform: rotate(90deg);
            }
            .layout-fullscreen .card {
                transform: rotate(-90deg);
                width: 90vh;
                max-height: 90vw;
            }
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
            }
            .custom-select {
                padding: 0.5rem 2rem 0.5rem 0.75rem;
                font-size: 0.75rem;
                background-size: 0.875rem;
            }
        }

        body.dark {
            background-color: var(--dark-bg);
            color: var(--dark-text-primary);
        }
        body.dark .card {
            background-color: var(--dark-card-bg);
            border-color: var(--dark-border);
        }
        body.dark .text-slate-800 { color: var(--dark-text-primary); }
        body.dark .text-slate-700 { color: var(--dark-text-primary); }
        body.dark .text-slate-600 { color: var(--dark-text-secondary); }
        body.dark .text-slate-500 { color: var(--dark-text-secondary); }
        body.dark .bg-slate-50 { background-color: var(--dark-input-bg); }
        body.dark .border-slate-200 { border-color: var(--dark-border); }
        body.dark .establishment-line { border-left-color: var(--dark-border); }
        body.dark input, body.dark .custom-select {
            background-color: var(--dark-input-bg);
            border-color: var(--dark-border);
            color: var(--dark-text-primary);
        }
        body.dark .custom-select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23f1f5f9'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
        }
        body.dark .btn-primary {
            background: linear-gradient(to bottom, #f87171, #ef4444);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        body.dark .btn-primary:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }
        body.dark .btn-primary:focus {
            box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.4);
        }
        body.dark .btn-secondary {
            background-color: #475569;
        }
        body.dark .btn-secondary:hover {
            background-color: #334155;
            transform: scale(1.05);
        }
        body.dark .btn-secondary:focus {
            box-shadow: 0 0 0 3px rgba(71, 85, 105, 0.4);
        }
        body.dark .btn-delete {
            background-color: #7f1d1d;
            color: #fecaca;
        }
        body.dark .btn-delete:hover {
            background-color: #991b1b;
            transform: scale(1.1);
        }
        body.dark .btn-delete:focus {
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.4);
        }
        body.dark #pressure-circle {
            stroke: #2dd4bf;
        }
        body.dark #pressure-background-fill {
            fill: var(--dark-card-bg);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="dark-mode-toggle-container">
        <div class="dark-mode-btn">
            <div class="dark-mode-btn__indicator">
                <div class="dark-mode-btn__icon-container">
                    <i class="fas fa-sun dark-mode-btn__icon"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-slate-800">HydroCalc</h1>
        </header>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
            <div id="config-panel" class="lg:col-span-2 space-y-6"></div>
            <div id="results-container" class="w-full">
                <div class="card sticky top-8">
                     <h2 class="text-xl font-bold mb-4 text-center text-slate-700">Pression à la pompe</h2>
                     <div class="flex justify-center items-center my-6">
                        <div class="relative w-48 h-48">
                            <svg class="w-full h-full" viewBox="0 0 120 120">
                                <circle id="pressure-background-fill" cx="60" cy="60" r="54" fill="white" style="transition: fill 0.5s ease-out;" />
                                <circle id="pressure-circle" cx="60" cy="60" r="54" fill="none" stroke="#4ade80" stroke-width="12"
                                        stroke-linecap="round"
                                        transform="rotate(-90 60 60)"
                                        style="stroke-dasharray: 339.29; stroke-dashoffset: 339.29; transition: stroke-dashoffset 0.5s ease-out, stroke 0.5s ease-out;" />
                            </svg>
                            <div id="pressure-text-container" class="absolute inset-0 flex flex-col justify-center items-center transition-colors duration-500">
                                <span id="final-pressure" class="text-5xl font-black text-slate-800">0</span>
                                <span class="block text-xl font-semibold text-slate-500">bars</span>
                            </div>
                        </div>
                     </div>
                     <div class="space-y-3">
                        <div class="flex justify-between items-center p-2 rounded-lg bg-slate-50">
                            <span class="font-semibold">Débit Total Requis :</span>
                            <span id="total-debit" class="font-bold text-lg">0 L/min</span>
                        </div>
                        <div id="pressure-details" class="text-sm space-y-2"></div>
                        <div id="engin-status" class="text-sm space-y-2"></div>
                     </div>
                </div>
            </div>
        </div>
        <div id="layout-container" class="mt-8 hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-center text-slate-700">Schéma de l'établissement</h2>
                    <button id="fullscreen-toggle" class="text-slate-700 hover:text-slate-900" aria-label="Toggle fullscreen mode">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                <div class="layout-svg-container w-full overflow-x-auto p-4 relative">
                    <svg id="layout-svg" height="300"></svg>
                </div>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const body = document.querySelector('body');
        const darkModeBtn = document.querySelector('.dark-mode-btn');
        const darkModeIcon = document.querySelector('.dark-mode-btn__icon');
        const layoutContainer = document.getElementById('layout-container');
        const fullscreenToggle = document.getElementById('fullscreen-toggle');
        const svg = document.getElementById('layout-svg');

        if (!body || !darkModeBtn || !darkModeIcon || !layoutContainer || !fullscreenToggle || !svg) {
            console.error('Required DOM elements are missing');
            return;
        }

        function storeDarkMode(value) {
            localStorage.setItem('darkmode', value);
        }

        function loadDarkMode() {
            const darkmode = localStorage.getItem('darkmode');
            if (darkmode === 'true') {
                body.classList.add('dark');
                darkModeIcon.classList.remove('fa-sun');
                darkModeIcon.classList.add('fa-moon');
                document.querySelector('.dark-mode-btn__indicator').style.transform = 'translateX(30px)';
            } else {
                body.classList.remove('dark');
                darkModeIcon.classList.remove('fa-moon');
                darkModeIcon.classList.add('fa-sun');
                document.querySelector('.dark-mode-btn__indicator').style.transform = 'translateX(0)';
            }
        }

        darkModeBtn.addEventListener('click', () => {
            body.classList.toggle('dark');
            darkModeIcon.classList.add('animated');
            storeDarkMode(body.classList.contains('dark'));
            if (body.classList.contains('dark')) {
                darkModeIcon.classList.remove('fa-sun');
                darkModeIcon.classList.add('fa-moon');
            } else {
                darkModeIcon.classList.remove('fa-moon');
                darkModeIcon.classList.add('fa-sun');
            }
            setTimeout(() => {
                darkModeIcon.classList.remove('animated');
            }, 500);
        });

        loadDarkMode();

        fullscreenToggle.addEventListener('click', () => {
            layoutContainer.classList.toggle('layout-fullscreen');
            fullscreenToggle.innerHTML = layoutContainer.classList.contains('layout-fullscreen')
                ? '<i class="fas fa-compress"></i>'
                : '<i class="fas fa-expand"></i>';
            drawLayout();
        });

        const ENGINS = {
            FPTL: { nom: 'FPTL', debit: 1500, pression: 15 },
            FPT: { nom: 'FPT', debit: 2000, pression: 15 },
            FPTGP: { nom: 'FPTGP', debit: 3000, pression: 15 }
        };
        const LANCES = {
            'ldv500': { name: 'LDV 500 L/min', type: 'ldv', pressure: 6, debitMin: 100, debitMax: 500, debitDefaut: 500, inlets: 1, requiredDiameter: 45, abbr: 'LDV' },
            'canon_pocket': { name: 'Canon Pocket 1000 L/min', type: 'ldv', pressure: 6, debitMin: 500, debitMax: 1000, debitDefaut: 1000, inlets: 1, requiredDiameter: 70, abbr: 'POCKET' },
            'canon_pok_1': { name: 'Canon Pok 1 entrée 1000', type: 'ldv', pressure: 6, debitMin: 500, debitMax: 1000, debitDefaut: 1000, inlets: 1, requiredDiameter: 70, abbr: 'POK' },
            'lance_ecran_dn65': { name: 'Lance Ecran DN65 1200', type: 'ldv', pressure: 7, debitMin: 800, debitMax: 1200, debitDefaut: 1200, inlets: 1, requiredDiameter: 70, abbr: 'ECRAN' },
            'canon_lmp80': { name: 'Canon 2 entrées LMP80', type: 'ldv', pressure: 7, debitMin: 1500, debitMax: 3000, debitDefaut: 3000, inlets: 2, requiredDiameter: 70, abbr: 'LMP80' },
            'canon_pok_2': { name: 'Canon Pok 2 entrées 3000', type: 'ldv', pressure: 6, debitMin: 1500, debitMax: 3000, debitDefaut: 3000, inlets: 2, requiredDiameter: 70, abbr: 'POK' },
        };
        const PERTES_DE_CHARGE_REF = {
            45: { debitRef: 250, js: 1.5, d: 0.045 },
            70: { debitRef: 500, js: 0.6, d: 0.070 },
            110: { debitRef: 1000, js: 0.3, d: 0.110 }
        };

        let state = {
            engin: 'FPT',
            elevation: 0,
            departures: [],
            idCounter: 0,
        };

        const configPanel = document.getElementById('config-panel');
        if (!configPanel) {
            console.error('Config panel not found');
            return;
        }

        function initialize() {
            render();
        }

        function getElementByPath(path) {
            if (!path) return null;
            let current = { departures: state.departures };
            const parts = path.split('.');
            for (const part of parts) {
                if (!current) return null;
                if (part === 'next') {
                    current = current.next;
                    continue;
                }
                const match = part.match(/([a-zA-Z]+)(\d+)/);
                if (!match) return null;
                const [, key, indexStr] = match;
                const index = parseInt(indexStr);
                if (!current[key] || !current[key][index]) return null;
                current = current[key][index];
            }
            return current;
        }

        function updateValue(path, field, value) {
            try {
                if (path === null) {
                    const numValue = parseFloat(value);
                    state[field] = isNaN(numValue) ? value : numValue;
                } else {
                    const element = getElementByPath(path);
                    if (element) {
                        const numValue = parseFloat(value);
                        element[field] = isNaN(numValue) ? value : numValue;
                        if (field === 'lanceType') {
                            const lanceData = LANCES[value];
                            element.debit = lanceData.debitDefaut;
                            const parentPath = path.substring(0, path.lastIndexOf('.'));
                            const parentElement = getElementByPath(parentPath);
                            if (parentElement && parentElement.type === 'tuyau') {
                                parentElement.diametre = lanceData.requiredDiameter;
                            }
                        }
                    }
                }
                render();
            } catch (e) {
                console.error('Error in updateValue:', e);
            }
        }

        function addComponent(path, type) {
            try {
                const parentNode = getElementByPath(path);
                const newId = state.idCounter++;
                if (path === null && type === 'tuyau') {
                    const newPath = `departures${state.departures.length}`;
                    state.departures.push({ id: newId, path: newPath, type: 'tuyau', diametre: 70, longueur: 40, next: null });
                } else if (parentNode && parentNode.type === 'tuyau' && !parentNode.next) {
                    const newPath = `${path}.next`;
                    if (type === 'lance') {
                        const defaultLance = Object.keys(LANCES).find(k => LANCES[k].requiredDiameter === parentNode.diametre) || 'ldv500';
                        const lanceData = LANCES[defaultLance];
                        parentNode.next = { id: newId, path: newPath, type: 'lance', lanceType: defaultLance, debit: lanceData.debitDefaut };
                    } else if (type === 'division') {
                        parentNode.next = { id: newId, path: newPath, type: 'division', lines: [] };
                    }
                } else if (parentNode && parentNode.type === 'division') {
                    const newPath = `${path}.lines${parentNode.lines.length}`;
                    parentNode.lines.push({ id: newId, path: newPath, type: 'tuyau', diametre: 70, longueur: 40, next: null });
                }
                render();
            } catch (e) {
                console.error('Error in addComponent:', e);
            }
        }

        function addPredefinedSegment(type) {
            try {
                if (type === 'dal-dat-lat') {
                    state.departures = [];
                    const baseId = state.idCounter;
                    const departurePath = `departures0`;
                    const departure = {
                        id: baseId,
                        path: departurePath,
                        type: 'tuyau',
                        diametre: 70,
                        longueur: 40,
                        next: {
                            id: baseId + 1,
                            path: `${departurePath}.next`,
                            type: 'division',
                            lines: [
                                {
                                    id: baseId + 2,
                                    path: `${departurePath}.next.lines0`,
                                    type: 'tuyau',
                                    diametre: 70,
                                    longueur: 40,
                                    next: {
                                        id: baseId + 3,
                                        path: `${departurePath}.next.lines0.next`,
                                        type: 'division',
                                        lines: [
                                            {
                                                id: baseId + 4,
                                                path: `${departurePath}.next.lines0.next.lines0`,
                                                type: 'tuyau',
                                                diametre: 45,
                                                longueur: 60,
                                                next: {
                                                    id: baseId + 5,
                                                    path: `${departurePath}.next.lines0.next.lines0.next`,
                                                    type: 'lance',
                                                    lanceType: 'ldv500',
                                                    debit: LANCES['ldv500'].debitDefaut
                                                }
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    };
                    state.departures.push(departure);
                    state.idCounter = baseId + 6;
                }
                render();
            } catch (e) {
                console.error('Error in addPredefinedSegment:', e);
            }
        }

        function removeComponent(path) {
            try {
                const parts = path.split('.');
                const lastPart = parts.pop();
                const parentPath = parts.join('.');
                if (parentPath === '') {
                    const index = parseInt(lastPart.match(/\d+/)[0]);
                    state.departures.splice(index, 1);
                } else {
                    const parent = getElementByPath(parentPath);
                    if (!parent) return;
                    if (lastPart === 'next') {
                        parent.next = null;
                    } else if (parent.type === 'division') {
                        const index = parseInt(lastPart.match(/\d+/)[0]);
                        parent.lines.splice(index, 1);
                    }
                }
                rePath(state.departures, 'departures');
                render();
            } catch (e) {
                console.error('Error in removeComponent:', e);
            }
        }

        function rePath(nodes, basePath) {
            if (!nodes) return;
            nodes.forEach((node, i) => {
                try {
                    const currentBasePath = `${basePath}${i}`;
                    node.path = currentBasePath;
                    if (node.next) {
                        node.next.path = `${currentBasePath}.next`;
                        if (node.next.lines) rePath(node.next.lines, `${node.next.path}.lines`);
                    }
                    if (node.lines) rePath(node.lines, `${currentBasePath}.lines`);
                } catch (e) {
                    console.error('Error in rePath:', e);
                }
            });
        }

        function calculateIntermediateResults() {
            const results = new Map();
            const debitMap = new Map();
            state.departures.forEach((departure, index) => {
                calculateBranchDebits(departure, debitMap);
                const branchResult = calculateBranchPressure(departure, state.elevation, index + 1, debitMap);
                collectResults(departure, results, debitMap, branchResult);
            });
            return results;
        }

        function collectResults(node, results, debitMap, branchResult) {
            if (!node) return;
            try {
                if (node.type === 'tuyau') {
                    const debit = debitMap.get(node.id) || 0;
                    const ref = PERTES_DE_CHARGE_REF[node.diametre];
                    const ratioQ = debit > 0 ? debit / ref.debitRef : 1;
                    const pdc = ref.js * Math.pow(ratioQ, 2) * (node.longueur / 100);
                    results.set(node.id, { debit, pdc });
                    if (node.next) collectResults(node.next, results, debitMap, branchResult);
                } else if (node.type === 'lance') {
                    const lanceData = LANCES[node.lanceType];
                    const debit = node.debit || lanceData.debitDefaut;
                    const pressure = lanceData.pressure + (state.elevation / 10);
                    results.set(node.id, { debit, pressure });
                } else if (node.type === 'division') {
                    results.set(node.id, { debit: debitMap.get(node.id) || 0 });
                    node.lines.forEach(line => collectResults(line, results, debitMap, branchResult));
                }
            } catch (e) {
                console.error('Error in collectResults:', e);
            }
        }

        function render() {
            try {
                configPanel.innerHTML = createEnginCard();
                const establishmentCard = document.createElement('div');
                establishmentCard.className = 'card';
                establishmentCard.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-slate-700">2. Établissement</h2>
                        <div class="flex items-center gap-2">
                            <button class="btn btn-primary" onclick="window.app.addComponent(null, 'tuyau')">
                                <i class="fas fa-plus fa-sm mr-2"></i> Nouveau segment
                            </button>
                            <select class="custom-select" onchange="window.app.addPredefinedSegment(this.value)">
                                <option value="" selected disabled>Segment Défini</option>
                                <option value="dal-dat-lat">DAL-DAT-LAT</option>
                            </select>
                        </div>
                    </div>
                    <div id="departures-container" class="space-y-4"></div>
                    <div class="mt-6 text-center">
                        <button class="btn btn-primary text-lg" onclick="window.app.calculateAndDisplay()">Calculer</button>
                    </div>
                `;
                configPanel.appendChild(establishmentCard);
                const departuresContainer = document.getElementById('departures-container');
                if (!departuresContainer) {
                    console.error('Departures container not found');
                    return;
                }
                const intermediateResults = calculateIntermediateResults();
                if (state.departures.length === 0) {
                    departuresContainer.innerHTML = `<p class="text-slate-500 text-center italic">Aucun segment depuis l'engin.</p>`;
                    layoutContainer.classList.add('hidden');
                } else {
                    departuresContainer.innerHTML = '';
                    state.departures.forEach(dep => {
                        const nodeElement = createNodeElement(dep, intermediateResults);
                        if (nodeElement) departuresContainer.appendChild(nodeElement);
                    });
                    layoutContainer.classList.remove('hidden');
                    drawLayout();
                }
            } catch (e) {
                console.error('Error in render:', e);
            }
        }

        function createEnginCard() {
            return `
                <div class="card">
                    <h2 class="text-xl font-bold mb-4 text-slate-700">1. Configuration Globale</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="engin-select" class="block text-sm font-medium text-slate-600 mb-1">Type d'engin</label>
                            <select id="engin-select" class="custom-select w-full" onchange="window.app.updateValue(null, 'engin', this.value)">
                                <option value="FPTL" ${state.engin === 'FPTL' ? 'selected' : ''}>FPTL (1500 L/min, 15 bars)</option>
                                <option value="FPT" ${state.engin === 'FPT' ? 'selected' : ''}>FPT (2000 L/min, 15 bars)</option>
                                <option value="FPTGP" ${state.engin === 'FPTGP' ? 'selected' : ''}>FPTGP (3000 L/min, 15 bars)</option>
                            </select>
                        </div>
                        <div>
                            <label for="elevation" class="block text-sm font-medium text-slate-600 mb-1">Dénivelé total (m)</label>
                            <input type="number" id="elevation" value="${state.elevation}" step="1" placeholder="Positif si la lance est plus haute" class="w-full p-3 rounded-lg bg-slate-50 border border-slate-200" onchange="window.app.updateValue(null, 'elevation', this.value)">
                        </div>
                    </div>
                </div>
            `;
        }

        function createNodeElement(node, intermediateResults) {
            try {
                const el = document.createElement('div');
                el.className = 'p-4 rounded-lg bg-slate-50 border border-slate-200 space-y-3';
                if (node.type === 'tuyau') {
                    el.innerHTML = createTuyauUI(node, intermediateResults);
                    if (node.next) {
                        const nextElement = createNodeElement(node.next, intermediateResults);
                        if (nextElement) el.appendChild(nextElement);
                    } else {
                        const addNextDiv = document.createElement('div');
                        addNextDiv.innerHTML = createAddNextUI(node.path, node.diametre);
                        el.appendChild(addNextDiv);
                    }
                } else if (node.type === 'division') {
                    el.innerHTML = createDivisionUI(node, intermediateResults);
                } else if (node.type === 'lance') {
                    el.innerHTML = createLanceUI(node, intermediateResults);
                }
                return el;
            } catch (e) {
                console.error('Error in createNodeElement:', e);
                return null;
            }
        }

        function createTuyauUI(tuyau, intermediateResults) {
            try {
                const isLanceConnected = tuyau.next && tuyau.next.type === 'lance';
                const lanceData = isLanceConnected ? LANCES[tuyau.next.lanceType] : null;
                const isDiameterLocked = isLanceConnected && lanceData.inlets > 0;
                let diameterOptions = `
                    <option value="45" ${tuyau.diametre === 45 ? 'selected' : ''}>Ø 45 mm</option>
                    <option value="70" ${tuyau.diametre === 70 ? 'selected' : ''}>Ø 70 mm</option>
                    <option value="110" ${tuyau.diametre === 110 ? 'selected' : ''}>Ø 110 mm</option>
                `;
                if (isDiameterLocked) {
                    diameterOptions = `<option value="${lanceData.requiredDiameter}" selected>Ø ${lanceData.requiredDiameter} mm (verrouillé)</option>`;
                }
                const result = intermediateResults.get(tuyau.id) || { debit: 0, pdc: 0 };
                const resultText = result.debit > 0
                    ? `Pertes estimées : ${result.pdc.toFixed(1)} bar (Débit : ${result.debit} L/min)`
                    : 'Pertes : non calculé (aucun débit)';
                return `
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold text-slate-700">Tuyau</h4>
                        <button class="btn-delete" onclick="window.app.removeComponent('${tuyau.path}')"><i class="fas fa-times fa-sm"></i></button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Diamètre</label>
                            <select class="custom-select w-full" onchange="window.app.updateValue('${tuyau.path}', 'diametre', this.value)" ${isDiameterLocked ? 'disabled' : ''}>
                               ${diameterOptions}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Longueur (m)</label>
                            <input type="number" value="${tuyau.longueur}" min="0" step="20" class="w-full p-2 rounded-md bg-white border-slate-300" onchange="window.app.updateValue('${tuyau.path}', 'longueur', this.value)" />
                        </div>
                    </div>
                    <p class="text-xs text-slate-500">${resultText}</p>
                `;
            } catch (e) {
                console.error('Error in createTuyauUI:', e);
                return '';
            }
        }

        function createLanceUI(lance, intermediateResults) {
            try {
                const lanceData = LANCES[lance.lanceType];
                let options = '';
                Object.keys(LANCES).forEach(key => {
                    options += `<option value="${key}" ${lance.lanceType === key ? 'selected' : ''}>${LANCES[key].name}</option>`;
                });
                let debitUI = '';
                if (lanceData.type === 'ldv') {
                    debitUI = `
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Débit (L/min)</label>
                            <input type="number" value="${lance.debit}" min="${lanceData.debitMin}" max="${lanceData.debitMax}" class="w-full p-2 rounded-md bg-white border-slate-300" onchange="window.app.updateValue('${lance.path}', 'debit', this.value)" />
                        </div>
                    `;
                }
                const result = intermediateResults.get(lance.id) || { debit: lance.debit || lanceData.debitDefaut, pressure: lanceData.pressure + (state.elevation / 10) };
                const resultText = `Débit : ${result.debit} L/min, Pression : ${result.pressure.toFixed(1)} bar`;
                return `
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold text-slate-700">Lance</h4>
                        <button class="btn-delete" onclick="window.app.removeComponent('${lance.path}')"><i class="fas fa-times fa-sm"></i></button>
                    </div>
                    <div class="grid grid-cols-1 ${debitUI ? 'md:grid-cols-2' : ''} gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Type de lance</label>
                            <select class="custom-select w-full" onchange="window.app.updateValue('${lance.path}', 'lanceType', this.value)">
                                ${options}
                            </select>
                        </div>
                        ${debitUI}
                    </div>
                    <p class="text-xs text-slate-500">${resultText}</p>
                `;
            } catch (e) {
                console.error('Error in createLanceUI:', e);
                return '';
            }
        }

        function createDivisionUI(division, intermediateResults) {
            try {
                let linesUI = '';
                division.lines.forEach(line => {
                    const lineElement = createNodeElement(line, intermediateResults);
                    if (lineElement) {
                        linesUI += `<div class="establishment-line mt-3">${lineElement.outerHTML}</div>`;
                    }
                });
                const result = intermediateResults.get(division.id) || { debit: 0 };
                const resultText = result.debit > 0 ? `Débit total : ${result.debit} L/min` : 'Débit : non calculé';
                return `
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold text-slate-700">Division</h4>
                        <button class="btn-delete" onclick="window.app.removeComponent('${division.path}')"><i class="fas fa-times fa-sm"></i></button>
                    </div>
                    <p class="text-xs text-slate-500">${resultText}</p>
                    <div class="space-y-3 pl-4 border-l-2 border-slate-300">
                        ${linesUI}
                        <div class="pt-2">
                            <button class="btn btn-secondary text-xs" onclick="window.app.addComponent('${division.path}', 'tuyau')">
                                <i class="fas fa-plus fa-sm mr-2"></i> Ajouter une ligne
                            </button>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('Error in createDivisionUI:', e);
                return '';
            }
        }

        function createAddNextUI(path, hoseDiameter) {
            try {
                const compatibleLances = Object.keys(LANCES).filter(key => LANCES[key].requiredDiameter === hoseDiameter);
                if (compatibleLances.length === 0) {
                    return `<p class="text-center text-sm text-amber-600 bg-amber-100 p-2 rounded-md mt-4">Aucune lance compatible avec un tuyau de Ø${hoseDiameter}. Changez le diamètre du tuyau.</p>`;
                }
                return `
                    <div class="mt-4 pt-4 border-t border-dashed flex items-center justify-center gap-4">
                        <button class="btn btn-secondary text-sm" onclick="window.app.addComponent('${path}', 'division')">
                            <i class="fas fa-plus fa-sm mr-2"></i> Ajouter une Division
                        </button>
                        <button class="btn btn-secondary text-sm" onclick="window.app.addComponent('${path}', 'lance')">
                            <i class="fas fa-plus fa-sm mr-2"></i> Ajouter une Lance
                        </button>
                    </div>
                `;
            } catch (e) {
                console.error('Error in createAddNextUI:', e);
                return '';
            }
        }

        function updatePressureGauge(pressure, maxPressure) {
            try {
                const circle = document.getElementById('pressure-circle');
                const backgroundFill = document.getElementById('pressure-background-fill');
                const textContainer = document.getElementById('pressure-text-container');
                const pressureText = document.getElementById('final-pressure');

                if (!circle || !backgroundFill || !textContainer || !pressureText) {
                    console.error('Pressure gauge elements not found');
                    return;
                }

                const radius = circle.r.baseVal.value;
                const circumference = 2 * Math.PI * radius;
                const percentage = Math.min(pressure / maxPressure, 1);
                const offset = circumference - percentage * circumference;

                circle.style.strokeDasharray = `${circumference}`;
                circle.style.strokeDashoffset = offset;

                pressureText.textContent = pressure.toFixed(1);

                const defaultFill = body.classList.contains('dark') ? 'var(--dark-card-bg)' : 'white';
                backgroundFill.style.fill = defaultFill;
                textContainer.classList.remove('!text-red-500');

                const defaultStroke = body.classList.contains('dark') ? '#2dd4bf' : '#4ade80';

                if (pressure > maxPressure) {
                    circle.style.stroke = '#ef4444';
                    backgroundFill.style.fill = 'rgba(239, 68, 68, 0.2)';
                    textContainer.classList.add('!text-red-500');
                } else if (pressure >= maxPressure * 0.85) {
                    circle.style.stroke = '#f97316';
                } else if (pressure >= maxPressure * 0.66) {
                    circle.style.stroke = '#facc15';
                } else {
                    circle.style.stroke = defaultStroke;
                }
            } catch (e) {
                console.error('Error in updatePressureGauge:', e);
            }
        }

        function calculateBranchDebits(node, debitMap) {
            if (!node) return 0;
            try {
                let debit = 0;
                if (node.type === 'lance') {
                    debit = node.debit || 0;
                } else if (node.type === 'division') {
                    node.lines.forEach(line => {
                        debit += calculateBranchDebits(line, debitMap);
                    });
                } else if (node.type === 'tuyau') {
                    debit = calculateBranchDebits(node.next, debitMap);
                }
                debitMap.set(node.id, debit);
                return debit;
            } catch (e) {
                console.error('Error in calculateBranchDebits:', e);
                return 0;
            }
        }

        function calculateBranchPressure(node, elevation, branchIndex, debitMap) {
            if (!node) return { pressure: 0, details: [] };
            try {
                let branchDetails = [];
                if (node.type === 'lance') {
                    const lancePressure = LANCES[node.lanceType].pressure || 0;
                    const elevationPressure = elevation / 10;
                    branchDetails.push(`Lance (${LANCES[node.lanceType].name}): ${lancePressure.toFixed(1)} bar`);
                    if (elevation !== 0) {
                        branchDetails.push(`Dénivelé: ${elevationPressure.toFixed(1)} bar (${elevation} m)`);
                    }
                    return { pressure: lancePressure + elevationPressure, details: branchDetails };
                }
                if (node.type === 'division') {
                    let maxSubPressure = 0;
                    node.lines.forEach((line, index) => {
                        const subResult = calculateBranchPressure(line, elevation, `${branchIndex}.${index + 1}`, debitMap);
                        if (subResult.pressure > maxSubPressure) {
                            maxSubPressure = subResult.pressure;
                            branchDetails = subResult.details;
                        }
                    });
                    return { pressure: maxSubPressure, details: branchDetails };
                }
                if (node.type === 'tuyau') {
                    const resultAfter = calculateBranchPressure(node.next, elevation, branchIndex, debitMap);
                    const ref = PERTES_DE_CHARGE_REF[node.diametre];
                    const debit = debitMap.get(node.id) || 0;
                    const ratioQ = (resultAfter.pressure > 0 && debit > 0) ? debit / ref.debitRef : 1;
                    const jAdjusted = ref.js * Math.pow(ratioQ, 2);
                    const pdc = jAdjusted * (node.longueur / 100);
                    branchDetails = resultAfter.details;
                    branchDetails.push(`Tuyau Ø${node.diametre}mm (${node.longueur}m): ${pdc.toFixed(1)} bar`);
                    return { pressure: resultAfter.pressure + pdc, details: branchDetails };
                }
                return { pressure: 0, details: [] };
            } catch (e) {
                console.error('Error in calculateBranchPressure:', e);
                return { pressure: 0, details: [] };
            }
        }

        function calculateAndDisplay() {
            try {
                const enginData = ENGINS[state.engin];
                let totalDebit = 0;
                let maxPressure = 0;
                let pressureDetails = [];
                const debitMap = new Map();

                state.departures.forEach(departure => {
                    totalDebit += calculateBranchDebits(departure, debitMap);
                });

                state.departures.forEach((departure, index) => {
                    const branchResult = calculateBranchPressure(departure, state.elevation, index + 1, debitMap);
                    pressureDetails.push(`<div class="p-2 rounded-lg bg-slate-50"><strong>Ligne ${index + 1} :</strong><ul class="list-disc pl-5">${branchResult.details.map(detail => `<li>${detail}</li>`).join('')}</ul><strong>Total: ${branchResult.pressure.toFixed(1)} bar</strong></div>`);
                    if (branchResult.pressure > maxPressure) {
                        maxPressure = branchResult.pressure;
                    }
                });

                const pressionFinale = Math.round(maxPressure * 10) / 10;

                updatePressureGauge(pressionFinale, enginData.pression);

                const totalDebitEl = document.getElementById('total-debit');
                const pressureDetailsEl = document.getElementById('pressure-details');
                const enginStatusEl = document.getElementById('engin-status');

                if (!totalDebitEl || !pressureDetailsEl || !enginStatusEl) {
                    console.error('Result elements not found');
                    return;
                }

                totalDebitEl.textContent = `${totalDebit} L/min`;
                pressureDetailsEl.innerHTML = pressureDetails.join('');
                let statusHtml = '';
                if (totalDebit > enginData.debit) {
                    statusHtml += `<div class="p-2 rounded-lg bg-red-100 text-red-700"><strong>DANGER :</strong> Débit total requis (${totalDebit} L/min) dépasse la capacité de l'engin (${enginData.debit} L/min).</div>`;
                } else {
                    statusHtml += `<div class="p-2 rounded-lg bg-green-100 text-green-700"><strong>Débit OK :</strong> ${totalDebit} L/min / ${enginData.debit} L/min.</div>`;
                }
                if (pressionFinale > enginData.pression) {
                    statusHtml += `<div class="p-2 rounded-lg bg-red-100 text-red-700 mt-2"><strong>DANGER :</strong> Pression requise (${pressionFinale.toFixed(1)} bar) dépasse la capacité de l'engin (${enginData.pression} bar).</div>`;
                } else if (pressionFinale >= 13) {
                    statusHtml += `<div class="p-2 rounded-lg bg-orange-100 text-orange-700 mt-2"><strong>ATTENTION :</strong> Pression très élevée. Risque d'éclatement.</div>`;
                } else if (pressionFinale >= 10) {
                    statusHtml += `<div class="p-2 rounded-lg bg-yellow-100 text-yellow-700 mt-2"><strong>ATTENTION :</strong> Pression élevée. Vérifier les raccords.</div>`;
                } else {
                    statusHtml += `<div class="p-2 rounded-lg bg-green-100 text-green-700 mt-2"><strong>Pression OK :</strong> ${pressionFinale.toFixed(1)} bar / ${enginData.pression} bar.</div>`;
                }
                enginStatusEl.innerHTML = statusHtml;
                layoutContainer.classList.remove('hidden');
                drawLayout();
            } catch (e) {
                console.error('Error in calculateAndDisplay:', e);
            }
        }

        function drawLayout() {
            try {
                svg.innerHTML = '';
                const NODE_SIZE = { width: 90, height: 40 };
                const HOSE_HEIGHT = { 110: 14, 70: 10, 45: 6 };
                const HOSE_COLORS = { 110: '#3b82f6', 70: '#475569', 45: '#94a3b8' };
                const PADDING = 10;
                const LEVEL_HEIGHT = 80;
                const HORIZONTAL_SPACING = 30;
                const layoutMap = new Map();

                function getBranchWidth(node) {
                    if (!node) return 0;
                    let width = NODE_SIZE.width + HORIZONTAL_SPACING;
                    if (node.type === 'tuyau') {
                        width += 120;
                        return width + getBranchWidth(node.next);
                    } else if (node.type === 'division') {
                        width += HORIZONTAL_SPACING;
                        const subWidths = node.lines.map(line => getBranchWidth(line));
                        return width + Math.max(...subWidths, 0);
                    } else if (node.type === 'lance') {
                        return NODE_SIZE.width;
                    }
                    return 0;
                }

                function getBranchHeight(node) {
                    if (!node) return LEVEL_HEIGHT;
                    if (node.type === 'division') {
                        let totalSubHeight = 0;
                        if (node.lines.length > 0) {
                            node.lines.forEach(line => totalSubHeight += getBranchHeight(line));
                            return totalSubHeight;
                        }
                        return LEVEL_HEIGHT;
                    }
                    return getBranchHeight(node.next);
                }

                function calculateLayout(node, x, y) {
                    if (!node) return;
                    const segmentLength = 120;
                    let currentX = x;
                    layoutMap.set(node.id, { x: currentX, y: y });
                    if (node.type === 'tuyau') {
                        currentX += segmentLength + HORIZONTAL_SPACING;
                        calculateLayout(node.next, currentX, y);
                    } else if (node.type === 'division') {
                        currentX += NODE_SIZE.width;
                        const subBranchHeights = node.lines.map(line => getBranchHeight(line));
                        const totalSubHeight = subBranchHeights.reduce((a, b) => a + b, 0);
                        let startY = y - (totalSubHeight / 2) + (node.lines.length > 0 ? subBranchHeights[0] / 2 : 0);
                        node.lines.forEach((line, index) => {
                            const subHeight = subBranchHeights[index];
                            calculateLayout(line, currentX + HORIZONTAL_SPACING, startY);
                            startY += subHeight;
                        });
                    }
                }

                function drawNode(x, y, width, height, color, text) {
                    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', x); rect.setAttribute('y', y - height / 2);
                    rect.setAttribute('width', width); rect.setAttribute('height', height);
                    rect.setAttribute('fill', color); rect.setAttribute('ry', 8);
                    g.appendChild(rect);
                    const textEl = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textEl.setAttribute('x', x + width / 2); textEl.setAttribute('y', y);
                    textEl.setAttribute('text-anchor', 'middle'); textEl.setAttribute('dominant-baseline', 'middle');
                    textEl.setAttribute('font-weight', 'bold'); textEl.setAttribute('font-size', '11px');
                    textEl.setAttribute('fill', 'white');
                    textEl.textContent = text;
                    g.appendChild(textEl);
                    svg.appendChild(g);
                }

                function drawHose(x1, y1, x2, y2, height, color, label, numInlets = 1) {
                    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    const spacing = 12;
                    const startY = y1 - (numInlets - 1) * spacing / 2;
                    for (let i = 0; i < numInlets; i++) {
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', x1); line.setAttribute('y1', startY + i * spacing);
                        line.setAttribute('x2', x2); line.setAttribute('y2', startY + i * spacing);
                        line.setAttribute('stroke', color); line.setAttribute('stroke-width', height);
                        line.setAttribute('stroke-linecap', 'round');
                        g.appendChild(line);
                    }
                    const textEl = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textEl.setAttribute('x', (x1 + x2) / 2); textEl.setAttribute('y', y1 + 25);
                    textEl.setAttribute('text-anchor', 'middle');
                    textEl.setAttribute('class', 'fill-current text-slate-500 text-sm font-semibold');
                    textEl.textContent = label;
                    g.appendChild(textEl);
                    svg.appendChild(g);
                }

                function drawElevationArrow(x, y, elevation) {
                    if (elevation === 0) return;
                    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    const isPositive = elevation > 0;
                    const textEl = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textEl.setAttribute('x', x);
                    textEl.setAttribute('y', y);
                    textEl.setAttribute('text-anchor', 'start');
                    textEl.setAttribute('class', 'fill-current text-slate-500 text-sm font-semibold');
                    textEl.textContent = `${isPositive ? '↑' : '↓'} ${Math.abs(elevation)} m`;
                    g.appendChild(textEl);
                    svg.appendChild(g);
                }

                const totalEstablishmentHeight = state.departures.reduce((acc, dep) => acc + getBranchHeight(dep), 0);
                const totalEstablishmentWidth = state.departures.reduce((acc, dep) => Math.max(acc, getBranchWidth(dep)), NODE_SIZE.width + HORIZONTAL_SPACING);
                const svgHeight = Math.max(300, totalEstablishmentHeight + PADDING * 2);
                const svgWidth = totalEstablishmentWidth + PADDING * 2 + 60;
                svg.setAttribute('height', svgHeight);
                svg.setAttribute('width', svgWidth);
                const yOffset = (svgHeight / 2) - (totalEstablishmentHeight / 2);
                layoutMap.set('engin', { x: PADDING, y: svgHeight / 2 });
                let startY = yOffset;
                state.departures.forEach(dep => {
                    const branchHeight = getBranchHeight(dep);
                    calculateLayout(dep, PADDING + NODE_SIZE.width + HORIZONTAL_SPACING, startY + branchHeight / 2);
                    startY += branchHeight;
                });

                drawNode(layoutMap.get('engin').x, layoutMap.get('engin').y, NODE_SIZE.width, NODE_SIZE.height, '#f87171', state.engin);
                if (state.elevation !== 0) {
                    const arrowX = totalEstablishmentWidth + PADDING;
                    const arrowY = PADDING + 20;
                    drawElevationArrow(arrowX, arrowY, state.elevation);
                }

                function drawRecursive(node) {
                    if (!node) return;
                    const pos = layoutMap.get(node.id);
                    if (!pos) {
                        console.warn(`Position not found for node ID: ${node.id}`);
                        return;
                    }
                    if (node.type === 'tuyau') {
                        const nextPos = node.next ? layoutMap.get(node.next.id) : { x: pos.x + 120, y: pos.y };
                        if (!nextPos) {
                            console.warn(`Next position not found for node ID: ${node.id}`);
                            return;
                        }
                        const lanceData = (node.next && node.next.type === 'lance') ? LANCES[node.next.lanceType] : { inlets: 1 };
                        drawHose(pos.x - HORIZONTAL_SPACING, pos.y, nextPos.x, nextPos.y, HOSE_HEIGHT[node.diametre], HOSE_COLORS[node.diametre], `${node.longueur}m Ø${node.diametre}`, lanceData.inlets);
                        drawRecursive(node.next);
                    } else if (node.type === 'lance') {
                        drawNode(pos.x, pos.y, NODE_SIZE.width, NODE_SIZE.height, '#2563eb', LANCES[node.lanceType].abbr);
                    } else if (node.type === 'division') {
                        drawNode(pos.x, pos.y, NODE_SIZE.width, NODE_SIZE.height, '#3b82f6', 'DIV');
                        node.lines.forEach(line => {
                            const linePos = layoutMap.get(line.id);
                            if (linePos) {
                                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                                path.setAttribute('d', `M ${pos.x + NODE_SIZE.width} ${pos.y} L ${pos.x + NODE_SIZE.width + HORIZONTAL_SPACING/2} ${pos.y} L ${pos.x + NODE_SIZE.width + HORIZONTAL_SPACING/2} ${linePos.y} L ${linePos.x - HORIZONTAL_SPACING} ${linePos.y}`);
                                path.setAttribute('stroke', '#94a3b8');
                                path.setAttribute('stroke-width', '2');
                                path.setAttribute('fill', 'none');
                                svg.appendChild(path);
                                drawRecursive(line);
                            }
                        });
                    }
                }

                startY = yOffset;
                state.departures.forEach(dep => {
                    const branchHeight = getBranchHeight(dep);
                    const depPos = layoutMap.get(dep.id);
                    if (depPos) {
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        path.setAttribute('d', `M ${PADDING + NODE_SIZE.width} ${layoutMap.get('engin').y} L ${PADDING + NODE_SIZE.width + HORIZONTAL_SPACING/2} ${layoutMap.get('engin').y} L ${PADDING + NODE_SIZE.width + HORIZONTAL_SPACING/2} ${depPos.y} L ${depPos.x - HORIZONTAL_SPACING} ${depPos.y}`);
                        path.setAttribute('stroke', '#94a3b8');
                        path.setAttribute('stroke-width', '2');
                        path.setAttribute('fill', 'none');
                        svg.appendChild(path);
                        drawRecursive(dep);
                    }
                    startY += branchHeight;
                });
            } catch (e) {
                console.error('Error in drawLayout:', e);
            }
        }

        window.app = {
            updateValue,
            addComponent,
            removeComponent,
            calculateAndDisplay,
            addPredefinedSegment
        };

        initialize();
    });
    </script>
</body>
</html>